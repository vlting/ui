# Commit History

- `72086b2` feat(dating): implement all 26 dating module components
- `820b828` feat(dating): merge full dating module implementation

---

# Task 005 — Implement All Dating Module Components

## Overview

Task 004 re-evaluated the dating module, removed 4 obsolete components (SwipeDeck, SwipeCard, BoostBadge, SuperLikeIndicator), scaffolded 18 new components, created the example app skeleton, and wrote the PRD at `examples/dating/PRODUCT.md`. **This task picks up where 004 left off** — turning all 26 dating component stubs into fully implemented, accessible, tested components.

This is the largest single implementation task in the project. All 26 components must be implemented with:
- Real props (typed from scratch — NOT `GetProps<>`)
- Behavioral logic (event handlers, controlled state, keyboard support)
- Token-based styling (no hardcoded colors/spacing)
- Full accessibility (ARIA roles, labels, focus management, reduced motion)
- Upgraded tests (behavioral tests per each component's `.spec.md` section 9)

---

## Pre-flight Checklist

Before implementing, verify that task 004 has been completed:

1. **4 components removed:** `SwipeDeck`, `SwipeCard`, `BoostBadge`, `SuperLikeIndicator` should NOT exist in `src/dating/`
2. **18 new component stubs exist** in `src/dating/` (see full list below)
3. **`src/dating/index.ts`** barrel exports are updated (no removed components, all new ones added)
4. **`examples/dating/PRODUCT.md`** exists and contains the Kinship PRD
5. **`examples/dating/`** example app skeleton exists

If any of these are missing, scaffold them first following the patterns in task 004 before proceeding.

---

## Required Reading

Before writing any code, read these files:

1. `AI_CONSTITUTION.md` (repo root) — presentation-only, no business logic, no data fetching
2. `DESIGN_CONSTITUTION.md` (repo root) — UX laws, accessibility requirements, design philosophy
3. `examples/dating/PRODUCT.md` — the Kinship PRD (source of truth for what each component does)
4. Each component's `.spec.md` file before implementing it — contains detailed visual, behavioral, accessibility, and test requirements
5. Each component's `.contract.md` file — contains prop contracts
6. `src/forms/_jsx-compat.ts` — the JSX compatibility pattern (MUST be replicated for dating module)

---

## Critical: Tamagui v2 RC Workarounds

These bugs are MANDATORY to work around in every implemented component:

### 1. Create `src/dating/_jsx-compat.ts`

The dating module needs its own `_jsx-compat.ts` mirroring `src/forms/_jsx-compat.ts`. This file re-exports all Tamagui primitives and Lucide icons as loosely-typed components to work around the v2 RC `GetFinalProps<>` bug.

```ts
import type { ComponentType } from 'react'
import {
  YStack as _YStack,
  XStack as _XStack,
  Text as _Text,
  View as _View,
  Image as _Image,
  ScrollView as _ScrollView,
  Sheet as _Sheet,
  Dialog as _Dialog,
  Separator as _Separator,
  // Add any other Tamagui primitives used across dating components
} from 'tamagui'

// Add all Lucide icons used across dating components:
import {
  Heart as _Heart,
  X as _X,
  Camera as _Camera,
  Plus as _Plus,
  MapPin as _MapPin,
  ChevronRight as _ChevronRight,
  Clock as _Clock,
  MessageCircle as _MessageCircle,
  Shield as _Shield,
  Flag as _Flag,
  Send as _Send,
  Check as _Check,
  AlertTriangle as _AlertTriangle,
  // ... etc
} from '@tamagui/lucide-icons'

type AnyProps = Record<string, unknown>
type AnyFC = ComponentType<AnyProps>
export type IconFC = ComponentType<{ size?: number; color?: string; 'aria-hidden'?: boolean }>

export const YStack = _YStack as AnyFC
export const XStack = _XStack as AnyFC
export const Text = _Text as AnyFC
export const View = _View as AnyFC
export const Image = _Image as AnyFC
export const ScrollView = _ScrollView as AnyFC
export const Sheet = _Sheet as AnyFC
export const Dialog = _Dialog as AnyFC
export const Separator = _Separator as AnyFC

export const Heart = _Heart as unknown as IconFC
export const X = _X as unknown as IconFC
export const Camera = _Camera as unknown as IconFC
export const Plus = _Plus as unknown as IconFC
export const MapPin = _MapPin as unknown as IconFC
export const ChevronRight = _ChevronRight as unknown as IconFC
export const Clock = _Clock as unknown as IconFC
export const MessageCircle = _MessageCircle as unknown as IconFC
export const Shield = _Shield as unknown as IconFC
export const Flag = _Flag as unknown as IconFC
export const Send = _Send as unknown as IconFC
export const Check = _Check as unknown as IconFC
export const AlertTriangle = _AlertTriangle as unknown as IconFC
```

Add more primitives and icons as needed during implementation. This file is shared across all dating components.

### 2. Props: Define from Scratch

Do NOT use `GetProps<typeof Frame>` for component props — it causes all props to type as `undefined` in v2 RC. Define props as plain TypeScript types:

```ts
// WRONG
export type MatchCardProps = GetProps<typeof MatchCardFrame>

// RIGHT
export type MatchCardProps = {
  name: string
  age: number
  photoSrc: string
  onPress?: () => void
  testID?: string
}
```

### 3. `styled()` with Token Defaults

Add `// @ts-expect-error Tamagui v2 RC` before every `styled()` call that has non-empty default variants or token values:

```ts
// @ts-expect-error Tamagui v2 RC
const CardFrame = styled(YStack, {
  padding: '$4',
  borderRadius: '$4',
  backgroundColor: '$background',
})
```

### 4. Pressable

Import `Pressable` from `react-native`, NOT from `tamagui`. Alternatively, use Tamagui `View` with `onPress` for simple press handling.

### 5. `styled()` Name Prop

Do NOT pass `name` to `styled()` — it causes TS errors in v2 RC. Omit it entirely.

### 6. Sub-component Casts

When using compound sub-components like `Popover.Trigger`, `Sheet.Frame`, etc., cast them:
```ts
const SheetFrame = Sheet.Frame as React.ComponentType<Record<string, unknown>>
```

---

## Implementation Approach

### Order of Implementation

Implement components in dependency order — leaf components first, then composites that use them:

**Phase 1 — Create `_jsx-compat.ts`**
1. `src/dating/_jsx-compat.ts`

**Phase 2 — Leaf / Simple Components (no internal component dependencies)**
2. `MatchRequestBadge` — simple visual indicator
3. `MatchRequestButton` — simple button with state
4. `PodCountdown` — timer display
5. `AgeRangeSelector` — dual-handle range slider
6. `DealBreakerSelector` — multi-select chips
7. `SafetyReportModal` — modal dialog
8. `BlockUserModal` — modal dialog (upgrade existing stub)
9. `LocationRadiusSelector` — slider (upgrade existing stub)
10. `InterestSelector` — chip selector (upgrade existing stub)
11. `PhotoGalleryUploader` — grid uploader (upgrade existing stub)
12. `ConversationList` — list component
13. `ConnectionCard` — card component
14. `MatchCard` — card component (upgrade existing stub)

**Phase 3 — Compound Components (may use Phase 2 components internally)**
15. `PodMemberCard` — uses MatchRequestButton, MatchRequestBadge
16. `ProfilePreviewCard` — uses InterestSelector display (upgrade existing stub)
17. `ActivityThread` — threaded messages
18. `IceBreakerCard` — uses ActivityThread
19. `QuizCard` — quiz with results
20. `DirectMessageThread` — messaging UI
21. `ConnectionList` — uses ConnectionCard
22. `MatchList` — uses MatchCard (upgrade existing stub)
23. `DatingProfileEditor` — uses PhotoGalleryUploader, InterestSelector, LocationRadiusSelector (upgrade existing stub)
24. `PreferenceEditor` — uses AgeRangeSelector, InterestSelector, LocationRadiusSelector, DealBreakerSelector
25. `WeekEndReview` — uses PodMemberCard, MatchRequestButton
26. `PodView` — uses PodMemberCard, IceBreakerCard, QuizCard, PodCountdown
27. `PodIntro` — uses PodMemberCard

---

## Per-Component Implementation Instructions

For EACH component, follow this exact process:

1. **Read** the component's `.spec.md` and `.contract.md` files
2. **Implement** the component in the `.tsx` file, replacing the stub entirely
3. **Upgrade tests** in the `.test.tsx` file with behavioral tests from `.spec.md` section 9
4. **Do NOT modify** `index.ts` files (neither the component's nor the module's barrel)

### File Structure Per Component

```
src/dating/ComponentName/
  ComponentName.tsx           ← REPLACE stub with full implementation
  ComponentName.test.tsx      ← UPGRADE from stub test to behavioral tests
  ComponentName.spec.md       ← READ ONLY
  ComponentName.contract.md   ← READ ONLY
  index.ts                    ← DO NOT MODIFY
```

---

## Implementation Patterns

### Simple Component Template

```tsx
import React from 'react'
import { Pressable } from 'react-native'
import { YStack, XStack, Text } from '../_jsx-compat'

export type ComponentNameProps = {
  // Define ALL props from scratch
  testID?: string
}

export const ComponentName = React.memo(function ComponentName(props: ComponentNameProps) {
  const { testID, ...rest } = props

  return (
    <YStack testID={testID} role="..." aria-label="...">
      {/* Implementation */}
    </YStack>
  )
})
```

### Compound Component Template

```tsx
import React from 'react'
import { withStaticProperties } from 'tamagui'
import { YStack, XStack, Text } from '../_jsx-compat'

export type ComponentNameProps = {
  // Define ALL props from scratch
  testID?: string
  children?: React.ReactNode
}

const ComponentNameFrame = React.memo(function ComponentNameFrame(props: ComponentNameProps) {
  const { testID, children } = props
  return (
    <YStack testID={testID}>
      {children}
    </YStack>
  )
})

// Sub-components
type SubComponentProps = { children?: React.ReactNode }

const Header = React.memo(function Header(props: SubComponentProps) {
  return <XStack>{props.children}</XStack>
})

export const ComponentName = withStaticProperties(ComponentNameFrame, {
  Header,
  // ... other sub-components
})
```

### Test Template

```tsx
import { fireEvent, render, screen } from '../../__test-utils__/render'
import { ComponentName } from './ComponentName'

describe('ComponentName', () => {
  it('renders without crashing', () => {
    render(<ComponentName testID="test" /* required props */ />)
    expect(screen.getByTestId('test')).toBeTruthy()
  })

  // Add behavioral tests from .spec.md section 9
  it('calls onPress when pressed', () => {
    const onPress = jest.fn()
    render(<ComponentName onPress={onPress} testID="test" />)
    fireEvent.press(screen.getByTestId('test'))
    expect(onPress).toHaveBeenCalledTimes(1)
  })

  // Accessibility tests
  it('has correct ARIA attributes', () => {
    render(<ComponentName testID="test" name="Alex" />)
    const el = screen.getByTestId('test')
    expect(el.props.role).toBe('button')
    expect(el.props['aria-label']).toContain('Alex')
  })
})
```

---

## Detailed Specs for Each of the 26 Components

### Kept Components (8) — Upgrade from Stub

Each of these has detailed `.spec.md` and `.contract.md` files already. Read them for full requirements. Summary:

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 1 | **MatchCard** | Compound (`.Photo`, `.Name`, `.Age`, `.Bio`) | `name`, `age`, `photoSrc`, `bio?`, `isNew?`, `onPress?` | Pressable card, press animation, "new match" badge |
| 2 | **MatchList** | Functional | `matches[]`, `sections?`, `isLoading?`, `isError?`, `onRefresh?`, `onRetry?` | Scrollable list of MatchCards, empty/loading/error states, sections |
| 3 | **ProfilePreviewCard** | Compound (`.Photo`, `.Name`, `.Bio`, `.Interests`) | `name`, `age?`, `photoSrc`, `bio?`, `interests?[]`, `onPress?` | Read-only profile card, optional pressable |
| 4 | **DatingProfileEditor** | Functional (form) | `value: DatingProfileValue`, `onChange`, `onSave?`, `isSaving?`, `errors?` | Controlled form, inline validation, uses PhotoGalleryUploader + InterestSelector + LocationRadiusSelector |
| 5 | **InterestSelector** | Functional | `interests: InterestItem[]`, `value: string[]`, `onChange`, `maxSelections?` | Chip selector, `role="checkbox"` per chip, disabled at max |
| 6 | **PhotoGalleryUploader** | Functional | `photos: PhotoSlot[]`, `maxSlots?`, `onAdd`, `onRemove`, `onReorder` | 6-slot grid (3x2), drag reorder, progress overlay, delegated file access |
| 7 | **LocationRadiusSelector** | Functional | `value: number`, `onChange`, `min?`, `max?`, `step?`, `unit?`, `onUnitChange?` | Slider with `role="slider"`, keyboard (arrows/Home/End), unit toggle |
| 8 | **BlockUserModal** | Functional | `open`, `onConfirm`, `onCancel`, `userName?`, `isLoading?`, `error?` | Modal/Sheet dialog, focus trap, Escape dismisses, loading/error states |

### New Components (18) — Implement from Stub

These were scaffolded by task 004. Each should have `.spec.md` and `.contract.md` files created by the scaffolding process. If they don't exist, create minimal ones before implementing.

#### Pod Components

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 9 | **PodView** | Compound (`.Header`, `.MemberGrid`, `.Activity`, `.Countdown`) | `podName?`, `memberCount?`, `daysRemaining?`, `children` | Main pod container, grid of members, activity feed area, countdown |
| 10 | **PodMemberCard** | Compound (`.Photo`, `.Name`, `.Bio`, `.MatchButton`) | `name`, `photoSrc`, `bio?`, `matchStatus?`, `onPress?`, `onMatchRequest?` | Member tile, shows match status badge, pressable to view profile |
| 11 | **PodCountdown** | Functional | `endDate: Date \| string`, `label?` | Countdown timer display (days/hours/minutes remaining), `role="timer"` |
| 12 | **PodIntro** | Compound (`.Welcome`, `.Members`, `.FirstActivity`) | `podName?`, `memberCount?`, `children` | Welcome screen for new pod week, introduces members |

#### Activity Components

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 13 | **IceBreakerCard** | Compound (`.Prompt`, `.ResponseList`, `.Input`) | `prompt: string`, `responses?[]`, `onSubmitResponse?`, `hasResponded?` | Shows daily prompt, response list, input for new response |
| 14 | **QuizCard** | Compound (`.Question`, `.Options`, `.Results`) | `question: string`, `options: QuizOption[]`, `selectedOption?`, `onSelect?`, `showResults?`, `results?` | Quiz question, selectable options, results view with vote counts |
| 15 | **ActivityThread** | Compound (`.Header`, `.Messages`, `.Input`) | `messages: ThreadMessage[]`, `onSendMessage?`, `title?` | Threaded conversation for activity responses, message list + input |

#### Match / Connection Components

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 16 | **MatchRequestButton** | Functional | `status: 'none' \| 'sent' \| 'received' \| 'mutual'`, `onPress?`, `disabled?` | Button states: Send/Cancel/Mutual, visual states per status |
| 17 | **MatchRequestBadge** | Functional | `status: 'none' \| 'pending' \| 'mutual'` | Small badge/dot indicator, color-coded by status |
| 18 | **WeekEndReview** | Compound (`.MemberList`, `.MatchPrompt`, `.Summary`) | `members: PodMember[]`, `selectedIds: string[]`, `onToggleSelect?`, `onSubmit?` | End-of-week UI, select pod members to match with, confirmation |
| 19 | **ConnectionCard** | Compound (`.Photo`, `.Name`, `.LastMessage`) | `name`, `photoSrc`, `lastMessage?`, `lastMessageTime?`, `unread?`, `onPress?` | Card for persistent connection, shows last message preview |
| 20 | **ConnectionList** | Functional | `connections: ConnectionItem[]`, `isLoading?`, `emptyMessage?` | Scrollable list of ConnectionCards, empty/loading states |

#### Messaging Components

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 21 | **DirectMessageThread** | Compound (`.Header`, `.Messages`, `.Input`) | `messages: DMMessage[]`, `recipientName?`, `onSendMessage?`, `onBack?` | Full DM conversation UI, message bubbles, input with send |
| 22 | **ConversationList** | Functional | `conversations: ConversationItem[]`, `isLoading?`, `emptyMessage?` | List of DM conversations, unread indicators, last message preview |

#### Preference / Filter Components

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 23 | **PreferenceEditor** | Compound (`.AgeRange`, `.Interests`, `.Location`, `.DealBreakers`) | `value: PreferenceValue`, `onChange`, `onSave?`, `isSaving?` | Controlled preference form, uses sub-editors |
| 24 | **AgeRangeSelector** | Functional | `min: number`, `max: number`, `value: [number, number]`, `onChange`, `bounds?` | Dual-handle range slider, `role="slider"` x2, keyboard support |
| 25 | **DealBreakerSelector** | Functional | `options: DealBreakerOption[]`, `value: string[]`, `onChange` | Multi-select list/chips for hard filters (smoking, kids, etc.) |

#### Safety Components

| # | Component | Type | Key Props | Key Behavior |
|---|-----------|------|-----------|-------------|
| 26 | **SafetyReportModal** | Functional | `open`, `onSubmit`, `onCancel`, `userName?`, `reportReasons?: string[]` | Report modal with reason selection + optional details text, focus trap |

---

## Styling Guidelines

All styling must use Tamagui design tokens. Common token mappings:

| Purpose | Token | Example |
|---------|-------|---------|
| Background | `$background` | Card surface, modal content |
| Text | `$color` | Primary text |
| Subtle text | `$colorSubtle` or `$gray10` | Secondary info, timestamps |
| Border | `$borderColor` | Card borders, input borders |
| Accent | `$accentColor` or brand token | Selected states, primary actions |
| Error/Danger | `$red10` | Error text, destructive actions |
| Success | `$green10` | Mutual match, success states |
| Warning | `$yellow10` | Pending states |
| Spacing | `$1` through `$8` | Padding, gap, margin |
| Radius | `$2` through `$6` | Border radius |
| Shadow | `$shadowColor` | Card elevation |

Do NOT hardcode any hex colors, pixel spacing, or font sizes. Always use `$token` references.

---

## Accessibility Checklist (Per Component)

Every component MUST satisfy:

- [ ] All interactive elements are keyboard-focusable
- [ ] Logical tab order (no `tabIndex` hacks)
- [ ] Appropriate ARIA `role` on semantic containers
- [ ] `aria-label` or `aria-labelledby` on all interactive elements
- [ ] `aria-describedby` for error messages linked to inputs
- [ ] `aria-live` regions for dynamic content changes (counters, status updates)
- [ ] `aria-disabled="true"` on disabled elements (not just visual)
- [ ] Visible focus indicators (focus ring via token)
- [ ] `prefers-reduced-motion`: skip all entrance/exit/press animations
- [ ] Color alone never used to convey information (add icon/text/shape)
- [ ] Photo elements have `alt` text
- [ ] Modals: `role="dialog"`, `aria-modal="true"`, focus trap, Escape to close

---

## Test Requirements

Each component's test file must include:

1. **Render test**: Renders with required props without crashing
2. **Prop threading**: `testID` and key props render correctly
3. **Interaction tests**: All callbacks fire correctly (press, change, submit, etc.)
4. **Keyboard tests**: Enter/Space on buttons, arrow keys on sliders, Escape on modals
5. **State tests**: Loading, error, empty, disabled states render correctly
6. **Accessibility tests**: ARIA attributes are correct and update with state
7. **Reduced motion**: Animations disabled when `prefers-reduced-motion` is set (where applicable)

Use the existing test infrastructure:
```ts
import { fireEvent, render, screen, waitFor } from '../../__test-utils__/render'
```

---

## DO NOT

- Add business logic, API calls, data fetching, or state management beyond local UI state
- Use `GetProps<>` for prop types — define from scratch
- Import Tamagui primitives directly — use `_jsx-compat.ts`
- Hardcode colors, spacing, or font sizes — use tokens
- Add `name` to `styled()` calls
- Modify `index.ts` barrel files
- Modify `.spec.md` or `.contract.md` files
- Create new directories — all component directories should already exist from scaffolding
- Skip accessibility — every component must be fully accessible
- Implement routing, navigation, or page-level logic — components are presentation-only

---

## Completion Criteria

This task is complete when:

1. `src/dating/_jsx-compat.ts` exists with all needed re-exports
2. All 26 component `.tsx` files contain full implementations (no TODO stubs)
3. All 26 component `.test.tsx` files contain behavioral tests (not just "renders without crashing")
4. `npx tsc --noEmit` passes with no errors in `src/dating/`
5. All tests pass: `npx jest src/dating/`
6. No hardcoded colors, spacing, or font sizes anywhere in dating module
7. Every component has correct ARIA attributes per its spec
